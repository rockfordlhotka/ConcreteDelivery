@page "/orders"
@using ConcreteDelivery.Data.Entities
@using ConcreteDelivery.Web.Services
@inject OrderService OrderService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Orders</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-4">ðŸ“‹ Orders</h1>
                <p class="lead">Manage concrete delivery orders</p>
            </div>
            <div>
                <button class="btn btn-success btn-lg me-2" @onclick="CreateRandomOrders" disabled="@_isCreatingRandom">
                    @if (_isCreatingRandom)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-shuffle"></i> Create 5 Demo Orders
                </button>
                <button class="btn btn-primary btn-lg" @onclick="NavigateToNewOrder">
                    <i class="bi bi-plus-circle"></i> New Order
                </button>
            </div>
        </div>
    </div>

    @if (!_isLoaded)
    {
        <div class="row">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading orders...</p>
            </div>
        </div>
    }
    else if (_orders.Count == 0)
    {
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info text-center py-5">
                    <h4>No orders found</h4>
                    <p>Click the "New Order" button to create your first order.</p>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Distance</th>
                                <th>Plant</th>
                                <th>Truck</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in _orders)
                            {
                                <tr>
                                    <td>
                                        <strong>#@order.Id</strong>
                                    </td>
                                    <td>@order.CustomerName</td>
                                    <td>@order.DistanceMiles miles</td>
                                    <td>
                                        @if (order.Plant != null)
                                        {
                                            <span class="badge bg-info">@order.Plant.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not assigned</span>
                                        }
                                    </td>
                                    <td>
                                        @if (order.Truck != null)
                                        {
                                            <span class="badge bg-secondary">
                                                Truck #@order.TruckId - @order.Truck.DriverName
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not assigned</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(order.Status)">
                                            @order.Status
                                        </span>
                                    </td>
                                    <td>
                                        <small>@order.CreatedAt.ToLocalTime().ToString("MM/dd/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        @if (order.Status == "Pending" || order.Status == "Assigned")
                                        {
                                            <button class="btn btn-sm btn-outline-primary me-1" 
                                                    @onclick="() => NavigateToEditOrder(order.Id)">
                                                <i class="bi bi-pencil"></i> Edit
                                            </button>
                                        }
                                        
                                        @if (order.Status != "Delivered" && order.Status != "Cancelled")
                                        {
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    @onclick="() => ShowCancelConfirmation(order)"
                                                    disabled="@_isCancelling">
                                                <i class="bi bi-x-circle"></i> Cancel
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        @if (_orders.Count > 0)
        {
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-secondary">
                        <strong>Total Orders:</strong> @_orders.Count
                        <span class="ms-3"><strong>Pending:</strong> @_orders.Count(o => o.Status == "Pending")</span>
                        <span class="ms-3"><strong>Assigned:</strong> @_orders.Count(o => o.Status == "Assigned")</span>
                        <span class="ms-3"><strong>In Transit:</strong> @_orders.Count(o => o.Status == "InTransit")</span>
                        <span class="ms-3"><strong>Delivered:</strong> @_orders.Count(o => o.Status == "Delivered")</span>
                        <span class="ms-3"><strong>Cancelled:</strong> @_orders.Count(o => o.Status == "Cancelled")</span>
                    </div>
                </div>
            </div>
        }
    }
</div>

<!-- Cancel Confirmation Modal -->
@if (_orderToCancel != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cancel Order</h5>
                    <button type="button" class="btn-close" @onclick="HideCancelConfirmation"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to cancel order <strong>#@_orderToCancel.Id</strong> for <strong>@_orderToCancel.CustomerName</strong>?</p>
                    <div class="mb-3">
                        <label class="form-label">Reason for cancellation:</label>
                        <input type="text" class="form-control" @bind="_cancellationReason" placeholder="Enter reason..." />
                    </div>
                    @if (!string.IsNullOrWhiteSpace(_errorMessage))
                    {
                        <div class="alert alert-danger">@_errorMessage</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideCancelConfirmation" disabled="@_isCancelling">Close</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmCancelOrder" disabled="@_isCancelling">
                        @if (_isCancelling)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Cancel Order
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Order> _orders = new();
    private bool _isLoaded = false;
    private bool _isCreatingRandom = false;
    private Order? _orderToCancel = null;
    private string _cancellationReason = "Customer request";
    private bool _isCancelling = false;
    private string _errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadOrdersAsync();
    }

    private async Task LoadOrdersAsync()
    {
        _isLoaded = false;
        _orders = await OrderService.GetAllOrdersAsync();
        _isLoaded = true;
    }

    private async Task CreateRandomOrders()
    {
        _isCreatingRandom = true;
        try
        {
            await OrderService.CreateRandomOrdersAsync(5);
            await LoadOrdersAsync();
        }
        finally
        {
            _isCreatingRandom = false;
        }
    }

    private void NavigateToNewOrder()
    {
        NavigationManager.NavigateTo("/orders/new");
    }

    private void NavigateToEditOrder(int orderId)
    {
        NavigationManager.NavigateTo($"/orders/edit/{orderId}");
    }

    private void ShowCancelConfirmation(Order order)
    {
        _orderToCancel = order;
        _cancellationReason = "Customer request";
        _errorMessage = "";
    }

    private void HideCancelConfirmation()
    {
        _orderToCancel = null;
        _errorMessage = "";
    }

    private async Task ConfirmCancelOrder()
    {
        if (_orderToCancel == null) return;

        _isCancelling = true;
        _errorMessage = "";

        try
        {
            var success = await OrderService.CancelOrderAsync(_orderToCancel.Id, _cancellationReason);
            
            if (success)
            {
                await LoadOrdersAsync();
                HideCancelConfirmation();
            }
            else
            {
                _errorMessage = "Failed to cancel order. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isCancelling = false;
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning text-dark",
            "Assigned" => "bg-info text-dark",
            "InTransit" => "bg-primary",
            "Delivered" => "bg-success",
            "Cancelled" => "bg-secondary",
            _ => "bg-light text-dark"
        };
    }
}
